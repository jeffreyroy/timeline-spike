<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Categorized Timeline with Dates</title>
  <meta charset="utf-8" />
    <style type="text/css">
      svg#war {
        height: 740px;
        width: 1200px;
      }

      svg#peace {
        height: 60px;
        width: 1200px;
      }

      div.viz {
        height: 1000px;
        width: 1000px;
      }
      path.domain {
        stroke: none;
        stroke-width: 1px;
        fill: none;
      }
      g.tick > line {
        stroke-dasharray: 5 5;
        stroke: gray;
        stroke-width: 1px;
      }
      text, p, h1 {
        font-family: "Pontano Sans";
        margin: 10px 40px;
      }

      p:last-child {
        margin: 10px 40px 40px;
      }

      h1 {
        font-size: 28px;
      }

      text.periodLabel {
        font-family: "Six Caps";
      }
      g.tick > text {
        font-size: 16px;
      }
      </style>
      <link href='https://fonts.googleapis.com/css?family=Six+Caps' rel='stylesheet' type='text/css'>
      <link href='https://fonts.googleapis.com/css?family=Pontano+Sans' rel='stylesheet' type='text/css'>
</head>

<script src="d3.js" type="text/JavaScript"></script>
<script src="../d3.layout.timeline.js" charset="utf-8" type="text/javascript"></script>
<script src="simple_statistics.js" charset="utf-8" type="text/javascript"></script>

<script>

types = ["European","Native","Colonial","Latin American","Internal"];

colorScale = d3.scale.ordinal()
  .domain(types)
  .range(["#96abb1", "#313746", "#b0909d", "#687a97", "#292014"]);

d3.csv("wars.csv", function (csv) {
  var timeline = d3.layout.timeline()
    .size([900,80])
    .extent(["7-4-1770", "12-31-2015"])
    .padding(3)
    .maxBandHeight(12);

  xScale = d3.time.scale()
  .domain([new Date("7-4-1770"), new Date("12-31-2015")])
  .range([0,900]);

  xScaleYear = d3.scale.linear()
  .domain([1770, 2015])
  .range([0,900]);

  middles = csv
  .map(function (d) {return (xScale(new Date(d.start)) + xScale(new Date(d.end))) / 2});

  breaks = ss.ckmeans(middles,4);

  d3.select("svg#war").append("g").attr("class", "timeline")
  .attr("transform", "translate(0,150)")

  d3.select("svg#war").append("text").attr("x", 130)
  .attr("y", 70)
  .style("text-anchor", "start")
  .style("font-size", "60px")
  .text("All the Wars of the United States")

  axis = d3.svg.axis().scale(xScale)
  .orient("bottom")
  .tickSize(550)

  axisYear = d3.svg.axis().scale(xScaleYear)
  .orient("bottom")
  .tickSize(40)

  d3.select("g.timeline").append("g").attr("transform", "translate(100,15)")
  .call(axis);

types.forEach(function (type, i) {
  onlyThisType = csv.filter(function(d) {return d.sphere === type});

  theseBands = timeline(onlyThisType);

  d3.select("g.timeline").append("g")
  .attr("class", "categories")
  .attr("transform", "translate(100," + (35 + (i * 90)) + ")")
  .selectAll("rect")
  .data(theseBands)
  .enter()
  .append("rect")
  .attr("rx", 2)
  .attr("x", function (d) {return d.start})
  .attr("y", function (d) {return d.y})
  .attr("height", function (d) {return d.dy})
  .attr("width", function (d) {return d.end - d.start})
  .style("fill", function (d) {return colorScale(d.sphere)})
  .style("stroke", "none")
  .style("stroke-width", 1)
  .on("mouseover", function (d) {hoverText(d,i)});

d3.select("g.timeline").append("text")
  .text(type)
  .attr("y", 45 + (i * 90))
  .attr("x", 110)
  .style("font-size", "16px")
  .style("text-anchor", "end")

})

  periodBars = [];
  periods = ["Revolution", "Conquest", "Influence", "Empire"]

  breaks.forEach(function(breaks, i) {
    periodBars.push({start: breaks[0], end: breaks[breaks.length-1], name: periods[i]});

    d3.selectAll("rect")
    .filter(function(d) {return (d.start + d.end) / 2 >= breaks[0]})
    .each(function (d) {
      d.period = i;
    });
  });

  d3.select("g.timeline").selectAll("rect.periodBars")
  .data(periodBars)
  .enter()
  .insert("rect", "g")
  .attr("y", 15)
  .attr("x", function (d) {return d.start + 100})
  .attr("width", function (d) {return d.end - d.start})
  .attr("height", 545)
  .style("fill", "#f6f6f6")
  .style("fill-opacity", 1)

  d3.select("g.timeline").selectAll("text.periodBars")
  .data(periodBars)
  .enter()
  .insert("text", "g")
  .attr("y", 5)
  .attr("x", function (d) {return d.start + 98})
  .attr("class", "periodLabel")
  .style("font-weight", 400)
  .style("font-size", "56px")
  .style("fill", "#b8b8b8")
  .style("opacity", .6)
  .text(function (d) {return d.name})

  allBands = timeline(csv);

allBands.forEach(function(band) {band.startYear = band.originalStart.getFullYear();band.endYear = band.originalEnd.getFullYear();})

var x = 1776;

var nowar = [];
while (x <= 2015) {
  var wars = allBands.filter(function(d) {
    return d.startYear <= x && d.endYear >= x
  }).length;

  if (wars === 0) {
    nowar.push(x);
  }
  x++;
}

var peaceG = d3.select("svg#peace").append("g")
  .attr("transform", "translate(100,0)");

peaceG.append("g")
.call(axisYear);

peaceG
.selectAll("circle")
  .data(nowar)
  .enter()
  .append("circle")
  .attr("r", 3)
  .attr("cx", function (d) {return xScaleYear(d)})
  .attr("cy", 20);

  distributionData = [];

  allBands
  .sort(function (a,b) {
    if (a.start < b.start) {
      return -1;
    }
    if (b.start > a.start) {
      return 1;
    }
    return 1;
  })
  .forEach(function(d, i) {
    num = allBands.filter(function (p) {
      return (p.start <= d.start && p.end >= d.start)
    }).length;
    distributionData.push({x: d.start, y: num});

  })

  yRange = d3.extent(distributionData, function (d) {return d.y});
  distScale = d3.scale.linear().domain(yRange).range([100,0]);
  distLine = d3.svg.line().y(function (d) {return distScale(d.y)})
  .x(function (d) {return d.x})
  .interpolate("basis")

  var distG = d3.select("g.timeline").append("g")
  .attr("transform", "translate(100,450)");

  distG
  .append("text")
  .text("Concurrent war")
  .attr("x", 10)
  .attr("y", 70)
  .style("text-anchor", "end")

  distG
  .append("path")
  .style("fill", "none")
  .style("stroke", "gray")
  .style("stroke-width", "2px")
  .attr("d", distLine(distributionData));



})

function hoverText(d, i) {
  d3.selectAll("text.label")
  .remove();

  d3.select("g.timeline").append("text")
  .attr("class", "label")
  .attr("x", d.start + 100)
  .attr("y", d.y + (31 + (i * 90)))
  .style("opacity", .9)
  .style("fill", "white")
  .style("stroke", "white")
  .style("stroke-width", 2)
  .style("pointer-events", "none")
    .text("")
    .transition()
    .duration(d.name.length * 100)
     .tween("text", function() {
         var interpolator = d3.interpolateRound( 0, d.name.length );
        return function(t) {
          var c = Math.floor(t * (d.name.length))
            this.textContent = d.name.substring(0, interpolator(t));
        };
  })

  d3.select("g.timeline").append("text")
  .attr("class", "label")
  .attr("x", d.start + 100)
  .attr("y", d.y + (31 + (i * 90)))
  .style("pointer-events", "none")
    .text("")
    .transition()
    .duration(d.name.length * 100)
     .tween("text", function() {
         var interpolator = d3.interpolateRound( 0, d.name.length );
        return function(t) {
          var c = Math.floor(t * (d.name.length))
            this.textContent = d.name.substring(0, interpolator(t));
        };
  })

}

</script>
<body>
<div id="viz">
  <svg id="war" style="background:white;" height=800 width=1100>
  </svg>
  <p>For most of its nearly two and a half century history, the United States has been at war. Some of these wars, like the American Civil War, are terrible and bloody and well-remembered. Others, like the Powder River War, were small and mostly forgotten. One was the result of an individual military officer disregarding orders and invading Mexico to retrieve stolen cattle.</p>
  <p>The consistency of war, and the dissimilarities of the impact and cost of each war, tend to lead to framing war in terms of casualties. But the campaigns to subjugate the native nations of North America involved minescule casualties in comparison to the campaigns in Western Europe during the Great War and the Second World War.</p>
  <p>But the effect of those native campaigns, and similar actions to extend US colonial reach, need not be measured by simple body count. This chart shows only the number of wars and their duration, treating each war as individually significant as another. It also includes the sphere in which they took place along with four periods into which US warfare might be divided. It tells a story of a young nation struggling to establish itself, followed by a period of forced removal and relocation of the native tribes of North America. With this task complete, and the nature of global politics changing, US military action focused on influencing Latin America and colonial territories beyond the shores of North America. Finally, after World War II, the nature of US war changed again as the country extended and defended its dominance.</p>
  <p>In this case, the division into periods is based on a simple clustering algorithm that split the distribution of wars into four buckets based on the mean date of the war. Not arbitray but not authoritative, those buckets proved semantically meaningful enough that I named them. Like the data itself, which comes from <a target="_blank" href="https://en.wikipedia.org/wiki/List_of_wars_involving_the_United_States">an article Wikipedia</a>, the division and the story could be challenged. It is one perspective on the nature of war and the United States.</p>
  <h1>All the Peace of the United States</h1>
  <svg id="peace" style="background:white;" height=200 width=1100>
  </svg>
  <p>Another perspective is a timeline of the 39 years during which the United States was not at war.</p>

</div>
<footer>
</footer>
</body>
</html>